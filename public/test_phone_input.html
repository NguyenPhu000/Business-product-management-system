<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Phone Input Validation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/supplier-style.css">
    <style>
        body {
            padding: 50px;
            background: #f8f9fa;
        }
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin-top: 20px;
            padding: 15px;
            background: #e7f3ff;
            border-left: 4px solid #0d6efd;
            border-radius: 4px;
        }
        .test-result.success {
            background: #d1f2eb;
            border-left-color: #28a745;
        }
        .test-result.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h2 class="mb-4">
            <i class="fas fa-phone-alt"></i> Test Validation Số điện thoại
        </h2>
        
        <div class="alert alert-info">
            <strong>Hướng dẫn test:</strong>
            <ul class="mb-0 mt-2">
                <li>Thử gõ chữ (a, b, c...) → Sẽ bị <strong>chặn ngay</strong></li>
                <li>Thử gõ ký tự đặc biệt (@, #, -...) → Sẽ bị <strong>chặn ngay</strong></li>
                <li>Chỉ được gõ: <strong>số (0-9)</strong> và <strong>dấu + ở đầu</strong></li>
                <li>Dấu + chỉ được xuất hiện ở đầu tiên</li>
                <li>Độ dài tối đa: 16 ký tự</li>
            </ul>
        </div>

        <form id="testForm">
            <div class="mb-3">
                <label for="phone" class="form-label">
                    Số điện thoại <span class="text-danger">*</span>
                </label>
                <input type="tel" class="form-control form-control-lg" id="phone" name="phone" 
                       required inputmode="numeric" 
                       placeholder="Ví dụ: 0901234567 hoặc +84901234567"
                       autocomplete="off">
                <div class="form-text">
                    Độ dài hợp lệ: 7-15 chữ số (không tính dấu +)
                </div>
            </div>

            <div id="currentValue" class="mb-3">
                <strong>Giá trị hiện tại:</strong> <code id="valueDisplay">""</code>
            </div>

            <button type="submit" class="btn btn-primary btn-lg w-100">
                <i class="fas fa-check"></i> Kiểm tra Validation
            </button>
        </form>

        <div id="result" class="test-result" style="display: none;">
            <h5 id="resultTitle"></h5>
            <p id="resultMessage" class="mb-0"></p>
        </div>

        <div class="mt-4">
            <h5>Ví dụ số hợp lệ:</h5>
            <ul>
                <li><code>0901234567</code> ✅</li>
                <li><code>+84901234567</code> ✅</li>
                <li><code>0123456789</code> ✅</li>
                <li><code>+1234567890</code> ✅</li>
            </ul>
            
            <h5>Ví dụ số KHÔNG hợp lệ:</h5>
            <ul>
                <li><code>abc123</code> ❌ (có chữ - sẽ bị chặn khi gõ)</li>
                <li><code>090-123-4567</code> ❌ (có dấu - - sẽ bị chặn khi gõ)</li>
                <li><code>12345</code> ❌ (quá ngắn < 7 số)</li>
                <li><code>12345678901234567</code> ❌ (quá dài > 15 số)</li>
            </ul>
        </div>
    </div>

    <script>
    // Copy từ create.php - hàm showInlineTooltip
    function showInlineTooltip(message, inputEl) {
        const old = document.querySelector('.validation-tooltip');
        if (old) old.remove();

        const tip = document.createElement('div');
        tip.className = 'validation-tooltip';
        tip.innerHTML = '<span class="vt-icon"><i class="fas fa-exclamation-triangle"></i></span>' +
            '<div class="vt-message">' + message + '</div>' +
            '<button type="button" class="vt-close" aria-label="Close">&times;</button>';

        tip.style.position = 'absolute';
        tip.style.visibility = 'hidden';
        document.body.appendChild(tip);

        const rect = inputEl.getBoundingClientRect();
        tip.classList.remove('validation-tooltip-right');
        const measured = tip.getBoundingClientRect();
        let topPos = window.scrollY + rect.top - measured.height - 8;
        let leftPos = window.scrollX + rect.left + (rect.width - measured.width) / 2;

        if (topPos < window.scrollY + 8) {
            tip.classList.add('validation-tooltip-right');
            const measuredRight = tip.getBoundingClientRect();
            topPos = window.scrollY + rect.top + (rect.height - measuredRight.height) / 2;
            leftPos = window.scrollX + rect.right + 8;
            if (leftPos + measuredRight.width > window.scrollX + window.innerWidth - 12) {
                leftPos = window.scrollX + window.innerWidth - measuredRight.width - 12;
            }
        }

        tip.style.top = topPos + 'px';
        tip.style.left = leftPos + 'px';
        tip.style.visibility = 'visible';

        tip.querySelector('.vt-close').addEventListener('click', () => tip.remove());
        inputEl.addEventListener('focus', () => tip.remove(), { once: true });
        setTimeout(() => { if (tip.parentNode) tip.remove(); }, 6000);
    }

    const phoneEl = document.getElementById('phone');
    const valueDisplay = document.getElementById('valueDisplay');
    const resultDiv = document.getElementById('result');
    const resultTitle = document.getElementById('resultTitle');
    const resultMessage = document.getElementById('resultMessage');

    // Update hiển thị giá trị
    phoneEl.addEventListener('input', function(e) {
        valueDisplay.textContent = '"' + e.target.value + '"';
    });

    // CHẶN NGAY KHI GÕ
    phoneEl.addEventListener('input', function(e) {
        let value = e.target.value;
        let cursorPos = e.target.selectionStart;
        
        let cleaned = value.replace(/[^\d+]/g, '');
        
        let plusCount = (cleaned.match(/\+/g) || []).length;
        if (plusCount > 1) {
            let firstPlus = cleaned.indexOf('+');
            cleaned = cleaned.substring(0, firstPlus + 1) + cleaned.substring(firstPlus + 1).replace(/\+/g, '');
        }
        
        if (cleaned.indexOf('+') > 0) {
            cleaned = cleaned.replace(/\+/g, '');
        }
        
        if (cleaned.length > 16) {
            cleaned = cleaned.substring(0, 16);
        }
        
        if (value !== cleaned) {
            e.target.value = cleaned;
            e.target.setSelectionRange(cursorPos - 1, cursorPos - 1);
            showInlineTooltip('Chỉ được nhập số và dấu + ở đầu', phoneEl);
        }
    });

    // Validation khi submit
    document.getElementById('testForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const phone = phoneEl.value.trim();
        
        resultDiv.style.display = 'block';
        
        if (phone === '') {
            resultDiv.className = 'test-result error';
            resultTitle.innerHTML = '<i class="fas fa-times-circle"></i> Lỗi: Để trống';
            resultMessage.textContent = 'Số điện thoại không được để trống';
            showInlineTooltip('Số điện thoại không được để trống', phoneEl);
            phoneEl.focus();
            return;
        }
        
        const re = /^\+?\d{7,15}$/;
        if (!re.test(phone)) {
            resultDiv.className = 'test-result error';
            resultTitle.innerHTML = '<i class="fas fa-times-circle"></i> Lỗi: Format không hợp lệ';
            resultMessage.textContent = 'Số điện thoại không hợp lệ. Chỉ chứa chữ số và có thể bắt đầu bằng dấu +, độ dài 7-15 ký tự.';
            showInlineTooltip('Số điện thoại không hợp lệ. Chỉ chứa chữ số và có thể bắt đầu bằng dấu +, độ dài 7-15 ký tự.', phoneEl);
            phoneEl.focus();
            return;
        }
        
        resultDiv.className = 'test-result success';
        resultTitle.innerHTML = '<i class="fas fa-check-circle"></i> Thành công!';
        resultMessage.innerHTML = 'Số điện thoại <strong>' + phone + '</strong> hợp lệ!';
    });
    </script>
</body>
</html>
