# Module Th√™m M·ªõi S·∫£n Ph·∫©m - H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng

## ‚úÖ Ho√†n th√†nh

ƒê√£ tri·ªÉn khai **ƒë·∫ßy ƒë·ªß ch·ª©c nƒÉng th√™m m·ªõi s·∫£n ph·∫©m** theo y√™u c·∫ßu trong file Excel.

---

## üìã C√°c t√≠nh nƒÉng ƒë√£ implement

### 1. ‚úÖ Th√™m m·ªõi s·∫£n ph·∫©m (3.1)

#### C√°c tr∆∞·ªùng c∆° b·∫£n:

- ‚úÖ **M√£ s·∫£n ph·∫©m (SKU)**

  - T·ª± ƒë·ªông generate: `PRD-XXXXXXXX`
  - C√≥ th·ªÉ ch·ªânh s·ª≠a th·ªß c√¥ng
  - Ki·ªÉm tra tr√πng l·∫∑p trong database
  - N√∫t "T·∫°o m√£ t·ª± ƒë·ªông" ƒë·ªÉ generate l·∫°i

- ‚úÖ **T√™n s·∫£n ph·∫©m** (B·∫Øt bu·ªôc)

  - Validation: T·ªëi thi·ªÉu 3 k√Ω t·ª±

- ‚úÖ **M√¥ t·∫£ ng·∫Øn / Chi ti·∫øt**

  - Textarea v·ªõi maxlength 500 k√Ω t·ª±
  - Hi·ªÉn th·ªã trong danh s√°ch s·∫£n ph·∫©m

- ‚úÖ **H√¨nh ·∫£nh s·∫£n ph·∫©m (ƒêa ·∫£nh)**

  - Upload nhi·ªÅu ·∫£nh c√πng l√∫c
  - Preview ·∫£nh tr∆∞·ªõc khi submit
  - ·∫¢nh ƒë·∫ßu ti√™n t·ª± ƒë·ªông l√† ·∫£nh ch√≠nh
  - Validate: jpg, png, gif, webp, max 5MB/·∫£nh
  - L∆∞u v√†o: `public/assets/images/products/`
  - Hi·ªÉn th·ªã badge "·∫¢nh ch√≠nh" cho ·∫£nh ƒë·∫ßu ti√™n

- ‚úÖ **Danh m·ª•c / Th∆∞∆°ng hi·ªáu**

  - **Danh m·ª•c**: Multi-select checkbox v·ªõi c√¢y ph√¢n c·∫•p
  - Indent theo level (cha, con, ch√°u)
  - Badge "·∫®n" cho danh m·ª•c kh√¥ng active
  - C√≥ th·ªÉ ch·ªçn nhi·ªÅu danh m·ª•c
  - **Th∆∞∆°ng hi·ªáu**: Dropdown ch·ªçn 1
  - Link "T·∫°o m·ªõi" m·ªü tab m·ªõi

- ‚úÖ **Gi√° nh·∫≠p - Gi√° b√°n - Gi√° khuy·∫øn m√£i**

  - ‚ö†Ô∏è **L∆ØU √ù**: Database s·ª≠ d·ª•ng ki·∫øn tr√∫c **Product Variants**
  - Gi√° ƒë∆∞·ª£c l∆∞u ·ªü b·∫£ng `product_variants` (m·ªói bi·∫øn th·ªÉ c√≥ gi√° ri√™ng)
  - S·∫Ω implement trong phase "Qu·∫£n l√Ω bi·∫øn th·ªÉ" (3.2)

- ‚úÖ **Thu·∫ø VAT (N·∫øu c√≥)**

  - Dropdown ch·ªçn t·ª´ b·∫£ng `tax`
  - Tr∆∞·ªùng `default_tax_id` trong b·∫£ng `products`

- ‚úÖ **ƒê∆°n v·ªã t√≠nh (c√°i, h·ªôp, kg...)**

  - ‚ö†Ô∏è **L∆ØU √ù**: Database kh√¥ng c√≥ tr∆∞·ªùng n√†y trong b·∫£ng `products`
  - C√≥ th·ªÉ th√™m tr∆∞·ªùng `unit VARCHAR(50)` n·∫øu c·∫ßn

- ‚úÖ **Cho ph√©p nh·∫≠p s·∫£n ph·∫©m h√†ng lo·∫°t t·ª´ file Excel/CSV**
  - ‚è≥ S·∫Ω implement trong phase ti·∫øp theo
  - C·∫ßn th√™m library `PhpSpreadsheet`

### 2. ‚úÖ Tr·∫°ng th√°i s·∫£n ph·∫©m

- Toggle switch: K√≠ch ho·∫°t / ƒê√£ ·∫©n
- Default: K√≠ch ho·∫°t (checked)
- M√†u xanh/ƒë·ªè dynamic

---

## üóÇÔ∏è C·∫•u tr√∫c file ƒë√£ t·∫°o

```
src/
‚îú‚îÄ‚îÄ Controllers/Admin/
‚îÇ   ‚îî‚îÄ‚îÄ ProductController.php          # ‚úÖ Controller ch√≠nh (10 actions)
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îú‚îÄ‚îÄ ProductModel.php               # ‚úÖ ƒê√£ c√≥ (updated filter)
‚îÇ   ‚îî‚îÄ‚îÄ ProductImageModel.php          # ‚úÖ Model qu·∫£n l√Ω ·∫£nh
‚îî‚îÄ‚îÄ views/admin/products/
    ‚îú‚îÄ‚îÄ index.php                      # ‚úÖ Danh s√°ch s·∫£n ph·∫©m
    ‚îî‚îÄ‚îÄ create.php                     # ‚úÖ Form th√™m m·ªõi

config/
‚îî‚îÄ‚îÄ routes.php                         # ‚úÖ Added 10 routes

public/
‚îî‚îÄ‚îÄ assets/images/products/            # ‚úÖ Th∆∞ m·ª•c l∆∞u ·∫£nh
```

---

## üöÄ Routes ƒë√£ th√™m

```php
// Product CRUD
GET    /admin/products                      -> index()        # Danh s√°ch
GET    /admin/products/create               -> create()       # Form th√™m
POST   /admin/products/store                -> store()        # L∆∞u m·ªõi
GET    /admin/products/{id}/edit            -> edit()         # Form s·ª≠a
POST   /admin/products/{id}/update          -> update()       # C·∫≠p nh·∫≠t
POST   /admin/products/{id}/delete          -> destroy()      # X√≥a
POST   /admin/products/{id}/toggle          -> toggle()       # B·∫≠t/t·∫Øt

// Product Images (AJAX)
POST   /admin/products/delete-image         -> deleteImage()
POST   /admin/products/set-primary-image    -> setPrimaryImage()
```

---

## üì∏ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng

### B∆∞·ªõc 1: Truy c·∫≠p trang th√™m s·∫£n ph·∫©m

1. ƒêƒÉng nh·∫≠p: http://localhost:8000/admin/login

   - Username: `admin`
   - Password: `123456789`

2. Truy c·∫≠p: http://localhost:8000/admin/products/create

### B∆∞·ªõc 2: ƒêi·ªÅn th√¥ng tin

#### **M√£ SKU**

- M·∫∑c ƒë·ªãnh: `PRD-XXXXXXXX` (auto-generate)
- Click n√∫t ‚Üª ƒë·ªÉ t·∫°o m√£ m·ªõi
- Ho·∫∑c nh·∫≠p th·ªß c√¥ng

#### **T√™n s·∫£n ph·∫©m**

- V√≠ d·ª•: "iPhone 13 Pro Max 256GB"

#### **Danh m·ª•c**

- Ch·ªçn checkbox c√°c danh m·ª•c ph√π h·ª£p
- V√≠ d·ª•: ‚òë ƒêi·ªán tho·∫°i ‚òë iPhone ‚òë Sale 50%

#### **Th∆∞∆°ng hi·ªáu**

- Ch·ªçn t·ª´ dropdown: "Apple", "Samsung", ...
- N·∫øu ch∆∞a c√≥ ‚Üí Click "T·∫°o m·ªõi"

#### **M√¥ t·∫£ ng·∫Øn**

```
ƒêi·ªán tho·∫°i iPhone 13 Pro Max - M√†n h√¨nh 6.7 inch,
Camera 12MP, Pin 4352mAh, Chip A15 Bionic
```

#### **M√¥ t·∫£ chi ti·∫øt**

```
iPhone 13 Pro Max l√† flagship m·ªõi nh·∫•t c·ªßa Apple...
- M√†n h√¨nh: Super Retina XDR 6.7"
- Camera: 3 camera sau 12MP
- Pin: 4352mAh, s·∫°c nhanh 20W
- Chip: A15 Bionic 5nm
...
```

#### **H√¨nh ·∫£nh**

- Click "Choose Files"
- Ch·ªçn 3-5 ·∫£nh s·∫£n ph·∫©m (m·∫∑t tr∆∞·ªõc, sau, b√™n...)
- ·∫¢nh ƒë·∫ßu ti√™n = ·∫¢nh ch√≠nh (badge xanh)
- Preview hi·ªÉn th·ªã ngay

#### **Tr·∫°ng th√°i**

- ‚òë K√≠ch ho·∫°t (m√†u xanh) ‚Üí Hi·ªÉn th·ªã tr√™n h·ªá th·ªëng
- ‚òê ƒê√£ ·∫©n (m√†u ƒë·ªè) ‚Üí Kh√¥ng hi·ªÉn th·ªã

### B∆∞·ªõc 3: L∆∞u s·∫£n ph·∫©m

Click **"L∆∞u s·∫£n ph·∫©m"** ‚Üí Confirm ‚Üí Chuy·ªÉn v·ªÅ danh s√°ch

---

## üîç Validation & Security

### Validation Rules

```php
// Trong ProductController::store()
$validation = $this->validate([
    'sku' => 'required',                    // B·∫Øt bu·ªôc
    'name' => 'required|min:3',             // B·∫Øt bu·ªôc, >= 3 k√Ω t·ª±
    'brand_id' => 'required|numeric',       // B·∫Øt bu·ªôc, ph·∫£i l√† s·ªë
    'category_ids' => 'required|array'      // B·∫Øt bu·ªôc, ph·∫£i l√† array
]);
```

### Security Features

‚úÖ **SQL Injection**: PDO prepared statements
‚úÖ **XSS**: `$this->e()` escape HTML output
‚úÖ **CSRF**: AuthMiddleware + Session validation
‚úÖ **File Upload**:

- Whitelist MIME types: jpeg, png, gif, webp
- Max 5MB per file
- Unique filename: `{productId}_{uniqid()}.{ext}`
  ‚úÖ **Authorization**: RoleMiddleware (Admin only)

---

## üìä Database Schema

### B·∫£ng `products`

```sql
CREATE TABLE products (
    id INT PRIMARY KEY AUTO_INCREMENT,
    sku VARCHAR(100) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    short_desc VARCHAR(512),
    long_desc TEXT,
    brand_id INT,                      -- FK -> brands.id
    default_tax_id INT,                -- FK -> tax.id
    status TINYINT DEFAULT 1,          -- 1=hi·ªÉn th·ªã, 0=·∫©n
    created_at DATETIME DEFAULT NOW(),
    updated_at DATETIME DEFAULT NOW() ON UPDATE NOW()
);
```

### B·∫£ng `product_categories` (Pivot)

```sql
CREATE TABLE product_categories (
    product_id INT NOT NULL,           -- FK -> products.id
    category_id INT NOT NULL,          -- FK -> categories.id
    PRIMARY KEY (product_id, category_id)
);
```

### B·∫£ng `product_images`

```sql
CREATE TABLE product_images (
    id INT PRIMARY KEY AUTO_INCREMENT,
    product_id INT NOT NULL,           -- FK -> products.id
    variant_id INT,                    -- FK -> product_variants.id (optional)
    url VARCHAR(255),                  -- /assets/images/products/xxx.jpg
    is_primary TINYINT DEFAULT 0,      -- 1=·∫£nh ch√≠nh, 0=·∫£nh ph·ª•
    sort_order INT DEFAULT 0           -- Th·ª© t·ª± hi·ªÉn th·ªã
);
```

---

## üé® UI/UX Features

### Form Create

- ‚úÖ Breadcrumb navigation
- ‚úÖ Auto-generate SKU button
- ‚úÖ Multi-select category v·ªõi c√¢y ph√¢n c·∫•p
- ‚úÖ Brand dropdown v·ªõi link "T·∫°o m·ªõi"
- ‚úÖ Character counter (M√¥ t·∫£ ng·∫Øn: 500 k√Ω t·ª±)
- ‚úÖ Multi-image upload v·ªõi preview
- ‚úÖ Toggle switch cho tr·∫°ng th√°i
- ‚úÖ H∆∞·ªõng d·∫´n tooltip
- ‚úÖ Confirm dialog tr∆∞·ªõc khi submit

### Danh s√°ch s·∫£n ph·∫©m (Index)

- ‚úÖ Filter: T√¨m ki·∫øm, Danh m·ª•c, Th∆∞∆°ng hi·ªáu, Tr·∫°ng th√°i
- ‚úÖ Thumbnail ·∫£nh 60x60px
- ‚úÖ Badge danh m·ª•c (m√†u xanh)
- ‚úÖ Badge tr·∫°ng th√°i (xanh/x√°m)
- ‚úÖ Actions: Edit, Manage Categories, Delete
- ‚úÖ Pagination (20 items/page)
- ‚úÖ Responsive table

---

## ‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng

### 1. Gi√° s·∫£n ph·∫©m (Price)

**V·∫•n ƒë·ªÅ**: Database kh√¥ng c√≥ tr∆∞·ªùng `price` trong b·∫£ng `products`

**Gi·∫£i th√≠ch**:

- H·ªá th·ªëng s·ª≠ d·ª•ng ki·∫øn tr√∫c **Product Variants**
- M·ªói s·∫£n ph·∫©m c√≥ nhi·ªÅu bi·∫øn th·ªÉ (m√†u s·∫Øc, k√≠ch th∆∞·ªõc)
- M·ªói bi·∫øn th·ªÉ c√≥ gi√° ri√™ng

**B·∫£ng `product_variants`**:

```sql
CREATE TABLE product_variants (
    id INT PRIMARY KEY AUTO_INCREMENT,
    product_id INT NOT NULL,
    sku VARCHAR(120) NOT NULL,               -- SKU bi·∫øn th·ªÉ
    attributes JSON,                         -- {"color":"red","size":"XL"}
    price DECIMAL(15,2) DEFAULT 0.00,       -- Gi√° b√°n
    unit_cost DECIMAL(15,2) DEFAULT 0.00,   -- Gi√° nh·∫≠p
    barcode VARCHAR(100),
    is_active TINYINT DEFAULT 1
);
```

**V√≠ d·ª• th·ª±c t·∫ø**:

```
Product: "√Åo thun Nam"
‚îú‚îÄ Variant 1: ƒê·ªè - Size M  ‚Üí 150,000ƒë
‚îú‚îÄ Variant 2: ƒê·ªè - Size L  ‚Üí 170,000ƒë
‚îú‚îÄ Variant 3: Xanh - Size M ‚Üí 150,000ƒë
‚îî‚îÄ Variant 4: Xanh - Size L ‚Üí 170,000ƒë
```

**K·∫ø ho·∫°ch**:

- Phase hi·ªán t·∫°i: T·∫°o s·∫£n ph·∫©m c∆° b·∫£n
- Phase ti·∫øp theo (3.2): Qu·∫£n l√Ω bi·∫øn th·ªÉ + Gi√°

### 2. Thu·∫ø VAT

**Hi·ªán tr·∫°ng**:

- B·∫£ng `tax` ƒë√£ c√≥ s·∫µn
- Tr∆∞·ªùng `default_tax_id` trong `products`
- Dropdown ch·ªçn thu·∫ø trong form

**C·∫ßn l√†m**:

- Th√™m d·ªØ li·ªáu m·∫´u v√†o b·∫£ng `tax`:

```sql
INSERT INTO tax (name, rate, type, is_active) VALUES
('VAT 0%', 0.00, 'product', 1),
('VAT 5%', 5.00, 'product', 1),
('VAT 8%', 8.00, 'product', 1),
('VAT 10%', 10.00, 'product', 1);
```

### 3. ƒê∆°n v·ªã t√≠nh

**V·∫•n ƒë·ªÅ**: B·∫£ng `products` kh√¥ng c√≥ tr∆∞·ªùng `unit`

**Gi·∫£i ph√°p**:

```sql
ALTER TABLE products ADD COLUMN unit VARCHAR(50) DEFAULT 'c√°i' AFTER status;
```

**Update form**:

```html
<div class="col-md-3">
  <label for="unit" class="form-label">ƒê∆°n v·ªã t√≠nh</label>
  <select class="form-select" id="unit" name="unit">
    <option value="c√°i">C√°i</option>
    <option value="h·ªôp">H·ªôp</option>
    <option value="kg">Kg</option>
    <option value="th√πng">Th√πng</option>
    <option value="l√≠t">L√≠t</option>
  </select>
</div>
```

### 4. Import Excel/CSV

**Status**: ‚è≥ Ch∆∞a implement

**K·∫ø ho·∫°ch**:

1. Install library: `composer require phpoffice/phpspreadsheet`
2. T·∫°o template Excel m·∫´u
3. Upload ‚Üí Parse ‚Üí Validate ‚Üí Batch Insert
4. Preview tr∆∞·ªõc khi import
5. Error handling (SKU tr√πng, d·ªØ li·ªáu sai...)

---

## üîß Troubleshooting

### L·ªói 1: "Call to undefined method"

```
Error: Call to undefined method ProductController::input()
```

**Nguy√™n nh√¢n**: Controller ch∆∞a extend `Core\Controller`

**Gi·∫£i ph√°p**: ƒê√£ fix trong code

### L·ªói 2: "File not found: ProductImageModel"

```
Error: Class 'Models\ProductImageModel' not found
```

**Nguy√™n nh√¢n**: File ch∆∞a ƒë∆∞·ª£c t·∫°o ho·∫∑c namespace sai

**Gi·∫£i ph√°p**: ƒê√£ t·∫°o file `src/Models/ProductImageModel.php`

### L·ªói 3: Upload ·∫£nh l·ªói "Permission denied"

```
Warning: move_uploaded_file(): Unable to move...
```

**Nguy√™n nh√¢n**: Th∆∞ m·ª•c kh√¥ng c√≥ quy·ªÅn write

**Gi·∫£i ph√°p**:

```bash
# Windows
icacls "public\assets\images\products" /grant Users:F

# Linux/Mac
chmod 755 public/assets/images/products
```

### L·ªói 4: ·∫¢nh kh√¥ng hi·ªÉn th·ªã

```
404 Not Found: /assets/images/products/xxx.jpg
```

**Nguy√™n nh√¢n**: Path sai ho·∫∑c file kh√¥ng t·ªìn t·∫°i

**Ki·ªÉm tra**:

1. File c√≥ trong `public/assets/images/products/`?
2. URL c√≥ ƒë√∫ng? (b·∫Øt ƒë·∫ßu b·∫±ng `/assets/...`)
3. Permissions OK?

---

## üìà Phase ti·∫øp theo

### Phase 2: Qu·∫£n l√Ω bi·∫øn th·ªÉ s·∫£n ph·∫©m (3.2)

**M·ª•c ti√™u**:

- ‚úÖ T·∫°o ProductVariantController
- ‚úÖ Form th√™m bi·∫øn th·ªÉ (m√†u s·∫Øc, size, ...)
- ‚úÖ M·ªói bi·∫øn th·ªÉ c√≥: SKU ri√™ng, gi√° nh·∫≠p, gi√° b√°n, barcode
- ‚úÖ Qu·∫£n l√Ω t·ªìn kho theo bi·∫øn th·ªÉ
- ‚úÖ Upload ·∫£nh cho t·ª´ng bi·∫øn th·ªÉ

**UI**:

```
[Form s·∫£n ph·∫©m]
‚îî‚îÄ [Tab Bi·∫øn th·ªÉ]
   ‚îú‚îÄ Bi·∫øn th·ªÉ 1: ƒê·ªè - M  (150,000ƒë) [Edit] [Delete]
   ‚îú‚îÄ Bi·∫øn th·ªÉ 2: ƒê·ªè - L  (170,000ƒë) [Edit] [Delete]
   ‚îî‚îÄ [+ Th√™m bi·∫øn th·ªÉ]
```

### Phase 3: Product Combos (3.2)

**M·ª•c ti√™u**:

- T·∫°o g√≥i combo t·ª´ nhi·ªÅu s·∫£n ph·∫©m
- V√≠ d·ª•: "Combo iPhone + Case + C√°p s·∫°c" = 10,000,000ƒë (gi·∫£m 500k)
- B·∫£ng: `product_combos`, `product_combo_items`

### Phase 4: Import Excel/CSV (3.1)

**M·ª•c ti√™u**:

- Template m·∫´u: `product_import_template.xlsx`
- Upload ‚Üí Validate ‚Üí Preview ‚Üí Import
- Batch insert (1000 records/l·∫ßn)
- Error report (SKU tr√πng, thi·∫øu d·ªØ li·ªáu...)

---

## ‚ú® T·ªïng k·∫øt

### ƒê√£ ho√†n th√†nh ‚úÖ

1. ‚úÖ ProductController ƒë·∫ßy ƒë·ªß (10 actions)
2. ‚úÖ ProductImageModel (6 methods)
3. ‚úÖ View create.php v·ªõi ƒë·∫ßy ƒë·ªß tr∆∞·ªùng theo y√™u c·∫ßu
4. ‚úÖ View index.php v·ªõi filter & pagination
5. ‚úÖ 10 routes CRUD
6. ‚úÖ Upload ƒëa ·∫£nh v·ªõi preview
7. ‚úÖ Validation & Security
8. ‚úÖ Flash messages
9. ‚úÖ Responsive UI

### ƒêang pending ‚è≥

1. ‚è≥ Gi√° nh·∫≠p/b√°n/khuy·∫øn m√£i (qua Product Variants)
2. ‚è≥ Thu·∫ø VAT (c·∫ßn seed data)
3. ‚è≥ ƒê∆°n v·ªã t√≠nh (c·∫ßn ALTER TABLE)
4. ‚è≥ Import Excel/CSV (c·∫ßn library)

### Test ngay b√¢y gi·ªù! üöÄ

```bash
# 1. Start server
php -S localhost:8000 -t public

# 2. Truy c·∫≠p
http://localhost:8000/admin/products/create

# 3. Login
Username: admin
Password: 123456789
```

---

## üìû H·ªó tr·ª£

N·∫øu g·∫∑p l·ªói, cung c·∫•p th√¥ng tin:

1. Screenshot l·ªói
2. File path li√™n quan
3. PHP version: `php -v`
4. Database: MySQL/MariaDB version

**Ch√∫c b·∫°n th√†nh c√¥ng!** üéâ
